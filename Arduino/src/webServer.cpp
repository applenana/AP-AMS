#include "webServer.h"
#include "File.h"
AsyncWebServer server(80);

const char jsContent[] PROGMEM = R"rawliteral(
(function(){const f=document.createElement("link").relList;if(f&&f.supports&&f.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))d(a);new MutationObserver((a)=>{for(const c of a)if(c.type==="childList")for(const i of c.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&d(i)}).observe(document,{childList:!0,subtree:!0,});function s(a){const c={};return(a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?(c.credentials="include"):a.crossOrigin==="anonymous"?(c.credentials="omit"):(c.credentials="same-origin"),c)}function d(a){if(a.ep)return;a.ep=!0;const c=s(a);fetch(a.href,c)}})();function A(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var L={exports:{},},x={exports:{},};(function(){var l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",f={rotl:function(s,d){return(s<<d)|(s>>>(32-d))},rotr:function(s,d){return(s<<(32-d))|(s>>>d)},endian:function(s){if(s.constructor==Number)return(f.rotl(s,8)&16711935)|(f.rotl(s,24)&4278255360);for(var d=0;d<s.length;d++)s[d]=f.endian(s[d]);return s},randomBytes:function(s){for(var d=[];s>0;s--)d.push(Math.floor(Math.random()*256));return d},bytesToWords:function(s){for(var d=[],a=0,c=0;a<s.length;a++,c+=8)d[c>>>5]|=s[a]<<(24-(c%32));return d},wordsToBytes:function(s){for(var d=[],a=0;a<s.length*32;a+=8)d.push((s[a>>>5]>>>(24-(a%32)))&255);return d},bytesToHex:function(s){for(var d=[],a=0;a<s.length;a++)d.push((s[a]>>>4).toString(16)),d.push((s[a]&15).toString(16));return d.join("")},hexToBytes:function(s){for(var d=[],a=0;a<s.length;a+=2)d.push(parseInt(s.substr(a,2),16));return d},bytesToBase64:function(s){for(var d=[],a=0;a<s.length;a+=3)for(var c=(s[a]<<16)|(s[a+1]<<8)|s[a+2],i=0;i<4;i++)a*8+i*6<=s.length*8?d.push(l.charAt((c>>>(6*(3-i)))&63)):d.push("=");return d.join("")},base64ToBytes:function(s){s=s.replace(/[^A-Z0-9+\/]/gi,"");for(var d=[],a=0,c=0;a<s.length;c=++a%4)c!=0&&d.push(((l.indexOf(s.charAt(a-1))&(Math.pow(2,-2*c+8)-1))<<(c*2))|(l.indexOf(s.charAt(a))>>>(6-c*2)),);return d},};x.exports=f})();var H=x.exports,F={utf8:{stringToBytes:function(l){return F.bin.stringToBytes(unescape(encodeURIComponent(l)))},bytesToString:function(l){return decodeURIComponent(escape(F.bin.bytesToString(l)))},},bin:{stringToBytes:function(l){for(var f=[],s=0;s<l.length;s++)f.push(l.charCodeAt(s)&255);return f},bytesToString:function(l){for(var f=[],s=0;s<l.length;s++)f.push(String.fromCharCode(l[s]));return f.join("")},},},I=F;var O=function(l){return l!=null&&(M(l)||P(l)||!!l._isBuffer)};function M(l){return(!!l.constructor&&typeof l.constructor.isBuffer=="function"&&l.constructor.isBuffer(l))}function P(l){return(typeof l.readFloatLE=="function"&&typeof l.slice=="function"&&M(l.slice(0,0)))}(function(){var l=H,f=I.utf8,s=O,d=I.bin,a=function(c,i){c.constructor==String?i&&i.encoding==="binary"?(c=d.stringToBytes(c)):(c=f.stringToBytes(c)):s(c)?(c=Array.prototype.slice.call(c,0)):!Array.isArray(c)&&c.constructor!==Uint8Array&&(c=c.toString());for(var r=l.bytesToWords(c),p=c.length*8,n=1732584193,e=-271733879,o=-1732584194,t=271733878,u=0;u<r.length;u++)r[u]=(((r[u]<<8)|(r[u]>>>24))&16711935)|(((r[u]<<24)|(r[u]>>>8))&4278255360);(r[p>>>5]|=128<<p%32),(r[(((p+64)>>>9)<<4)+14]=p);for(var m=a._ff,g=a._gg,h=a._hh,y=a._ii,u=0;u<r.length;u+=16){var C=n,S=e,k=o,_=t;(n=m(n,e,o,t,r[u+0],7,-680876936)),(t=m(t,n,e,o,r[u+1],12,-389564586)),(o=m(o,t,n,e,r[u+2],17,606105819)),(e=m(e,o,t,n,r[u+3],22,-1044525330)),(n=m(n,e,o,t,r[u+4],7,-176418897)),(t=m(t,n,e,o,r[u+5],12,1200080426)),(o=m(o,t,n,e,r[u+6],17,-1473231341)),(e=m(e,o,t,n,r[u+7],22,-45705983)),(n=m(n,e,o,t,r[u+8],7,1770035416)),(t=m(t,n,e,o,r[u+9],12,-1958414417)),(o=m(o,t,n,e,r[u+10],17,-42063)),(e=m(e,o,t,n,r[u+11],22,-1990404162)),(n=m(n,e,o,t,r[u+12],7,1804603682)),(t=m(t,n,e,o,r[u+13],12,-40341101)),(o=m(o,t,n,e,r[u+14],17,-1502002290)),(e=m(e,o,t,n,r[u+15],22,1236535329)),(n=g(n,e,o,t,r[u+1],5,-165796510)),(t=g(t,n,e,o,r[u+6],9,-1069501632)),(o=g(o,t,n,e,r[u+11],14,643717713)),(e=g(e,o,t,n,r[u+0],20,-373897302)),(n=g(n,e,o,t,r[u+5],5,-701558691)),(t=g(t,n,e,o,r[u+10],9,38016083)),(o=g(o,t,n,e,r[u+15],14,-660478335)),(e=g(e,o,t,n,r[u+4],20,-405537848)),(n=g(n,e,o,t,r[u+9],5,568446438)),(t=g(t,n,e,o,r[u+14],9,-1019803690)),(o=g(o,t,n,e,r[u+3],14,-187363961)),(e=g(e,o,t,n,r[u+8],20,1163531501)),(n=g(n,e,o,t,r[u+13],5,-1444681467)),(t=g(t,n,e,o,r[u+2],9,-51403784)),(o=g(o,t,n,e,r[u+7],14,1735328473)),(e=g(e,o,t,n,r[u+12],20,-1926607734)),(n=h(n,e,o,t,r[u+5],4,-378558)),(t=h(t,n,e,o,r[u+8],11,-2022574463)),(o=h(o,t,n,e,r[u+11],16,1839030562)),(e=h(e,o,t,n,r[u+14],23,-35309556)),(n=h(n,e,o,t,r[u+1],4,-1530992060)),(t=h(t,n,e,o,r[u+4],11,1272893353)),(o=h(o,t,n,e,r[u+7],16,-155497632)),(e=h(e,o,t,n,r[u+10],23,-1094730640)),(n=h(n,e,o,t,r[u+13],4,681279174)),(t=h(t,n,e,o,r[u+0],11,-358537222)),(o=h(o,t,n,e,r[u+3],16,-722521979)),(e=h(e,o,t,n,r[u+6],23,76029189)),(n=h(n,e,o,t,r[u+9],4,-640364487)),(t=h(t,n,e,o,r[u+12],11,-421815835)),(o=h(o,t,n,e,r[u+15],16,530742520)),(e=h(e,o,t,n,r[u+2],23,-995338651)),(n=y(n,e,o,t,r[u+0],6,-198630844)),(t=y(t,n,e,o,r[u+7],10,1126891415)),(o=y(o,t,n,e,r[u+14],15,-1416354905)),(e=y(e,o,t,n,r[u+5],21,-57434055)),(n=y(n,e,o,t,r[u+12],6,1700485571)),(t=y(t,n,e,o,r[u+3],10,-1894986606)),(o=y(o,t,n,e,r[u+10],15,-1051523)),(e=y(e,o,t,n,r[u+1],21,-2054922799)),(n=y(n,e,o,t,r[u+8],6,1873313359)),(t=y(t,n,e,o,r[u+15],10,-30611744)),(o=y(o,t,n,e,r[u+6],15,-1560198380)),(e=y(e,o,t,n,r[u+13],21,1309151649)),(n=y(n,e,o,t,r[u+4],6,-145523070)),(t=y(t,n,e,o,r[u+11],10,-1120210379)),(o=y(o,t,n,e,r[u+2],15,718787259)),(e=y(e,o,t,n,r[u+9],21,-343485551)),(n=(n+C)>>>0),(e=(e+S)>>>0),(o=(o+k)>>>0),(t=(t+_)>>>0)}return l.endian([n,e,o,t])};(a._ff=function(c,i,r,p,n,e,o){var t=c+((i&r)|(~i&p))+(n>>>0)+o;return((t<<e)|(t>>>(32-e)))+i}),(a._gg=function(c,i,r,p,n,e,o){var t=c+((i&p)|(r&~p))+(n>>>0)+o;return((t<<e)|(t>>>(32-e)))+i}),(a._hh=function(c,i,r,p,n,e,o){var t=c+(i^r^p)+(n>>>0)+o;return((t<<e)|(t>>>(32-e)))+i}),(a._ii=function(c,i,r,p,n,e,o){var t=c+(r^(i|~p))+(n>>>0)+o;return((t<<e)|(t>>>(32-e)))+i}),(a._blocksize=16),(a._digestsize=16),(L.exports=function(c,i){if(c==null)throw new Error("Illegal argument "+c);var r=l.wordsToBytes(a(c,i));return i&&i.asBytes?r:i&&i.asString?d.bytesToString(r):l.bytesToHex(r)})})();var U=L.exports;const R=A(U),v=(l)=>{document.getElementById(l).classList.remove("hidden")},B=(l)=>{document.getElementById(l).classList.add("hidden")};(D=async(l)=>new Promise((f,s)=>{let d="",a=new FileReader();(a.onload=function(c){(d=R(c.target.result)),f(d)}),a.readAsArrayBuffer(l)})),(N=async(l)=>{B("uploadColumn"),v("progressColumn");let f="fr";try{let s=await D(l);const d=await fetch(`/ota/start?mode=${f}&hash=${s}`);if(!d.ok)throw new Error("Start OTA process failed");const a=await d.text();console.log("Start OTA response:",a);const c=new FormData();let i=new XMLHttpRequest();i.open("POST","/ota/upload"),(i.onreadystatechange=function(){if(i.readyState==4)if(i.status==200)B("progressColumn"),v("successColumn");else if(i.status==400){B("progressColumn"),v("errorColumn");let r=i.responseText}else B("progressColumn"),v("errorColumn")}),c.append("file",l,l.name),i.send(c)}catch(s){B("progressColumn"),v("errorColumn")}}),(V=(l)=>l.length>1&&!multiple?(alert("一次只能上传一个bin文件"),!1):l[0].name.split(".").pop()!="bin"?(alert("只能上传bin文件"),!1):!0);var q=document.getElementById("uploadButton"),$=document.getElementById("fileInput");q.addEventListener("click",function(l){l.preventDefault(),$.click()});function z(l){if(!V(l))return!1;N(l[0])}function G(){window.location.reload()}window.onFileInput=z;window.resetView=G;function callSetBackPullTime(){var inputElement=document.getElementById("backPullTimeInput");var backPullTime=parseInt(inputElement.value,10);if(isNaN(backPullTime)||backPullTime<0||backPullTime>255){alert("请输入0到255之间的数值");return}var url="/setBackPullTimeArgs?number="+encodeURIComponent(backPullTime);fetch(url,{method:"GET",}).then((response)=>response.text()).then((data)=>{if(data==="OK"){window.location.reload()}alert(data)}).catch((error)=>{console.error("Error:",error)})}function formatFS(){var url="/formatFS";fetch(url,{method:"GET",}).then((response)=>response.text()).then((data)=>{alert(data)}).catch((error)=>{console.error("Error:",error)})}function uploadFile(event){event.preventDefault();var formData=new FormData(document.getElementById("uploadForm"));var file=formData.get("file");if(!file){alert("请选择一个文件");return}const reader=new FileReader();reader.onload=async function(e){const arrayBuffer=e.target.result;const hash=R(arrayBuffer);const startUrl=`/ota/start?mode=fr&hash=${hash}`;try{const startResponse=await fetch(startUrl,{method:"GET",});if(!startResponse.ok){throw new Error("OTA进程失败");}const startData=await startResponse.text();console.log("Start OTA response:",startData);const uploadResponse=await fetch("/ota/upload",{method:"POST",body:formData,});const uploadData=await uploadResponse.text();document.getElementById("uploadResult").innerText=uploadData}catch(error){console.error("Error:",error);document.getElementById("uploadResult").innerText="上传失败"}finally{document.querySelector('#uploadForm button[type="submit"]').disabled=false}};document.querySelector('#uploadForm button[type="submit"]').disabled=true;reader.readAsArrayBuffer(file)}function showFileName(input){var fileName=input.files.length>0?input.files[0].name:"未选择文件";document.getElementById("fileNameDisplay").innerText=fileName}document.addEventListener("DOMContentLoaded",function(){resetFileInput()});function resetFileInput(){console.log(document.getElementById("uploadForm"))}
)rawliteral";

void recWebServer()
{

    // 首页
    server.on("/", HTTP_GET, [](AsyncWebServerRequest *request)
              {
                  const char* htmlContent = R"rawliteral(
<!DOCTYPE html><html><head><meta charset="utf-8"><title>FAKEAMSLIFE_WEB</title><link rel="stylesheet"href="styles.css"></head><body><div class="card"><h1>FAKEAMSLIFE_WEB</h1><h3>设置</h3><span class="tooltip"><p>退料时间（秒）：<input class="input"type="number"id="backPullTimeInput"placeholder="0-255"min="0"max="255"value="%d"></p><span class="tooltiptext">tips:时间设置为255为微动模式</span></span><a href="#"><button class="btn"onclick="callSetBackPullTime()">确认</button></a><h3>固件更新</h3><!--文件上传表单--><form id="uploadColumn"><button id="uploadButton"class="css-button-arrow--sky">上传</button><input type="file"id="fileInput"class="hidden"accept=".bin,.bin.gz"onchange="onFileInput(files)"></form><!--显示上传结果--><h2 id="progressColumn"class="hidden"><span style="color: #63bbd0;">请勿断电，更新中···</span></h2><h2 id="successColumn"class="hidden"><span style="color: #2c9678;">更新完成，自动重启APAMS,需大约10秒。</span></h2><h2 id="errorColumn"class="hidden"><span style="color: #ee3f4d;">更新失败，可以尝试重启APAMS再次更新。</span></h2><h3>其他</h3><span class="tooltip"><p>格式化文件系统：<a href="#"onclick="if (confirm('您确定要格式化文件系统吗？此操作将清除所有配置文件，且不可恢复。')) { formatFS(); }"><button class="btn">确认</button></a></p><span class="tooltiptext">清除配置文件（包括打印机通道配置，退料时间），和擦除有类似效果，不过不用担心不会影响固件</span></span><div><p>版本号：%s</p><p>本项目在applenana/AP-AMS基础上继续开发,遵循MIT License</p><p>PA1NCL0WN</p></div></div><script src="script.js"></script></body></html>)rawliteral";

                  char htmlContentStr[2048];
                  snprintf(htmlContentStr, sizeof(htmlContentStr), htmlContent,backStopTime, version);

                  request->send(200, "text/html", htmlContentStr); });

    // css
    server.on("/styles.css", HTTP_GET, [](AsyncWebServerRequest *request)
              {
    const char* cssContent = R"rawliteral(
.hidden{display:none}.tooltip{position:relative;display:inline-block;cursor:pointer}.tooltip .tooltiptext{visibility:hidden;width:30%;background-color:#000;color:#fff;text-align:center;border-radius:5px;padding:5px 0;position:absolute;z-index:1;bottom:90%;left:50%;margin-left:-60px;opacity:0;transition:opacity .3s}.tooltip:hover .tooltiptext{visibility:visible;opacity:1}.input{max-width:190px;padding:12px;border:none;border-radius:4px;box-shadow:2px 2px 7px 0 rgba(0,0,0,.2);outline:0;color:#696969}.input:invalid{animation:justshake .3s forwards;color:red}@keyframes justshake{25%{transform:translateX(5px)}50%{transform:translateX(-5px)}75%{transform:translateX(5px)}to{transform:translateX(-5px)}}.btn{width:130px;height:40px;font-size:1.1em;cursor:pointer;background-color:#171717;color:#fff;border:none;border-radius:5px;transition:all .4s}.btn:hover{border-radius:5px;transform:translateY(-10px);box-shadow:0 7px 0 -2px #f85959,0 15px 0 -4px #39a2db,0 16px 10px -3px #39a2db}.btn:active{transition:all .2s;transform:translateY(-5px);box-shadow:0 2px 0 -2px #f85959,0 8px 0 -4px #39a2db,0 12px 10px -3px #39a2db}.card{width:80%;height:80%;margin:0 auto;border-radius:50px;background:#e0e0e0;box-shadow:20px 20px 60px #bebebe,-20px -20px 60px #fff;display:flex;flex-direction:column;justify-content:space-between;text-align:center;margin - top:10px;margin - bottom:10px}.css-button-arrow--sky{min-width:130px;height:40px;color:#fff;padding:5px 10px;font-weight:700;cursor:pointer;transition:all .3s ease;position:relative;display:inline-block;outline:0;overflow:hidden;border-radius:5px;border:none;background-color:#3a86ff}.css-button-arrow--sky:hover{border-radius:5px;padding-right:24px;padding-left:8px}.css-button-arrow--sky:hover:after{opacity:1;right:10px}.css-button-arrow--sky:after{content:"\00BB";position:absolute;opacity:0;font-size:20px;line-height:40px;top:0;right:-20px;transition:.4s}#uploadResult{margin-top:20px;font-size:1.2em;color:#333}
    )rawliteral";
    request->send(200, "text/css", cssContent); });
    // js
    server.on("/script.js", HTTP_GET, [](AsyncWebServerRequest *request)
              { request->send_P(200, "text/javascript", jsContent); });
    // 设置停止延迟接口
    server.on("/setBackPullTimeArgs", HTTP_GET, [](AsyncWebServerRequest *request)
              {
                  if (request->hasArg("number"))
                  {
                      String paramValueStr = request->arg("number");
                      int tempValue = paramValueStr.toInt();
                      if (tempValue >= 0 && tempValue <= 255)
                      {
                          backStopTime = uint8_t(tempValue);
                          setBackPullTime(backStopTime);

                      }
                    request->send(200, "text/plain", "OK");
                    return;
                  }
                  request->send(200, "text/plain", "FAIL"); });
    // 格式化FS功能
    server.on("/formatFS", HTTP_GET, [](AsyncWebServerRequest *request)
              {
                  if (formatFS())
                  {
                    request->send(200, "text/plain", "OK");
                    return;
                  }
                  request->send(200, "text/plain", "FAIL"); });
}